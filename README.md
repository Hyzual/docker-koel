docker-koel
===========

[![docker-pulls-badge]][docker-hub] ![github-workflow-status]

A docker image with only the bare essentials needed to run [koel]. It includes
apache and a php runtime with required extensions.

## Usage

Start the koel server with a [mysql] database and expose port 80.

```bash
docker run -d --name koel -p 80:80 hyzual/koel
```

On the first run, you will need to generate `JWT_SECRET`, `APP_KEY`, create an admin user and initialize the database. Run the following command.

```bash
docker exec -it koel bash
# Once inside the container, you can run commands:
$ php artisan koel:init
```

`koel:init` will fail at the stage where it checks front-end assets. This is known and is due to the absence of node.js and yarn. koel's frontend assets are already built in this image so this step is not necessary.

koel's [`.env.example`][koel-env-example] file will be copied to `.env` in `/var/www/html`. It contains most of koel's configuration.

### How to bind-mount the `.env` file

To be sure to preserve `APP_KEY` and `JWT_SECRET`, you can choose to bind-mount the `.env` file to your host:

```bash
# On your host, create an `.env` file:
touch .env
# Then, you can bind-mount it directly in the container.
docker run -d --name koel --mount type=bind,source="$(pwd)"/.env,target=/var/www/html/.env hyzual/koel
docker exec -it koel bash
# In the container, init
$ php artisan koel:init
```

### Pass environment variables

Once you have generated an `APP_KEY` and `JWT_SECRET`, you can provide them as environment variables to your container to preserve them.

```bash
# Run a container just to generate the key
docker run -it --rm hyzual/koel bash
# In the container, generate APP_KEY and JWT_SECRET
$ php artisan key:generate --force
$ php artisan koel:generate-jwt-secret
# Show the modified .env file
$ cat .env
# Copy the APP_KEY and JWT_SECRET variables
$ exit
```

You can then provide the variables to your real container:

```bash
docker run -d --name koel --env APP_KEY=<your_app_key> --env JWT_SECRET=<your_secret> -p 80:80 hyzual/koel
# Even better, write an env-file in your host and pass it to the container
docker run -d --name koel --env-file .koel.env -p 80:80 hyzual/koel
```

### Scan media folders

Whenever the music in `/music` changes, you will need to manually scan it before
koel is able to play it. Run the following command:

```bash
docker exec koel php artisan koel:sync
```

## Usage with docker-compose
-------

[docker-compose] can be used to start koel along with its depdencies. Just run.

```bash
docker-compose up
```

On the first start (after an upgrade or initial installation), the database
needs to be migrated. Run koel init with `docker exec` in the koel runtime
container:

```bash
docker-compose exec koel php artisan koel:init
```

Check out the [`./docker-compose.yml`][compose] file for more information.

## Useful environment variables

See [`.env.example`][koel-env-example] for reference.

- `APP_KEY`: a base64 string. It is generated by `php artisan koel:init` or by `php artisan key:generate`. Once you have scanned music, DO NOT CHANGE `APP_KEY`. Songs are identified by a combination of `APP_KEY` and their path, so if `APP_KEY` changes, the next `php artisan koel:scan` will report all songs as changed.
- `JWT_SECRET`: a random 32-char string. It is generated by `php artisan koel:init` or by `php artisan koel:generate-jwt-secret`. DO NOT CHANGE `JWT_SECRET` once it is set. You will need it to login.
- `FORCE_HTTPS`: if set to `true`, all URLs redirects done by koel will use `https`. If you have setup a reverse-proxy in front of this container that supports `https`, set it to `true`.
- `MEMORY_LIMIT`: amount of memory in MB for the scanning process. Set this if `php artisan koel:scan` runs out of memory.
- `LASTFM_API_KEY` and `LASTFM_API_SECRET`: Enable scrobbling to Last.fm. See https://koel.phanan.net/docs/#/3rd-party?id=last-fm

## Volumes

### /music

`/music` will contain the music library. Keep in mind that koel needs to
scan music before it's able to play it.

## Ports

### 80

Only HTTP is provided. Consider setting up a reverse-proxy to provide HTTPS support.

## Workdir

### /var/www/html

Apache's root directory. All koel files will be here. If you `exec` into the container, this will be your current directory.

[koel-env-example]: https://github.com/phanan/koel/blob/v4.1.1/.env.example
[koel]: https://koel.phanan.net/
[compose]: ./docker-compose.yml
[mysql]: https://hub.docker.com/r/mysql/mysql-server
[docker-compose]: https://docs.docker.com/compose/

[github-workflow-status]: <https://img.shields.io/github/workflow/status/hyzual/docker-koel/Docker Image CI>
[docker-pulls-badge]: <https://img.shields.io/docker/pulls/hyzual/koel>
[docker-hub]: https://hub.docker.com/r/hyzual/koel
